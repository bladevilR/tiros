<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.report.cost.mapper.BuWorkOrderMaterialReportMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.report.cost.bean.BuWorkOrderMaterial">
        <id column="id" property="id"/>
        <result column="order_id" property="orderId"/>
        <result column="order_task_id" property="orderTaskId"/>
        <result column="material_type_id" property="materialTypeId"/>
        <result column="amount" property="amount"/>
        <result column="act_amount" property="actAmount"/>
        <result column="remark" property="remark"/>
        <result column="use_category" property="useCategory"/>
        <result column="is_verify" property="isVerify"/>
        <result column="op_type" property="opType"/>
        <result column="is_gen_order" property="isGenOrder"/>
        <result column="plan_amount" property="planAmount"/>
        <result column="need_dispatchin" property="needDispatchin"/>
        <result column="system_id" property="systemId"/>
        <result column="workstation_id" property="workstationId"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, order_id, order_task_id, material_type_id, amount, act_amount, remark, use_category,
        is_verify, op_type, is_gen_order, plan_amount, need_dispatchin, system_id, workstation_id
    </sql>

    <select id="selectListByCondition" resultType="org.jeecg.modules.report.cost.bean.BuWorkOrderMaterial">
        select
        t.*,
        t4.price as materialTypePrice,
        t4.code as materialTypeCode,
        t4.name as materialTypeName,
        t4.spec as materialTypeSpec,
        t4.unit as materialTypeUnit,
        t4.category2,
        t5.code as systemCode,
        NVL(t5.short_name, t5.name) as systemName,
        t6.station_no as workstationNo,
        t6.name as workstationName,
        (select SUM(a.act_amount) from bu_work_order_material_acts a
        where a.order_material_id = t.id and a.act_amount > 0) as consumeAmount,
        (select SUM(a.act_amount * a.price) from bu_work_order_material_acts a
        where a.order_material_id = t.id and a.act_amount > 0) as consumeTotalPrice,
        t3.start_time as consumeTime
        from bu_work_order_material t
        left join bu_material_apply_detail t1 on t1.order_material_id = t.id
        left join bu_work_order_task t2 on t2.id = t.order_task_id
        left join bu_work_order t3 on t3.id = t2.order_id
        left join bu_material_type t4 on t4.id = t.material_type_id
        left join bu_train_asset_type t5 on t5.id = t.system_id
        left join bu_mtr_workstation t6 on t6.id = t.workstation_id
        where t3.order_type not in (4, 5) and t3.order_status in (3, 4)
        <if test="queryVO.depotId != null and queryVO.depotId != ''">
            <if test="queryVO.lineId == null or queryVO.lineId == ''">
                and t3.line_id in (select line_id from bu_mtr_depot_line where depot_id = #{queryVO.depotId})
            </if>
        </if>
        <if test="queryVO.lineId != null and queryVO.lineId != ''">
            and t3.line_id = #{queryVO.lineId}
        </if>
        <if test="queryVO.trainNo != null and queryVO.trainNo != ''">
            and t3.train_no = #{queryVO.trainNo}
        </if>
        <if test="queryVO.useCategoryList != null and queryVO.useCategoryList.size > 0">
            and t.use_category in
            <foreach collection="queryVO.useCategoryList" item="useCategory" open="(" separator="," close=")">
                #{useCategory}
            </foreach>
        </if>
        <if test="queryVO.category2 != null and queryVO.category2 != ''">
            and t4.category2 = #{queryVO.category2}
        </if>
        <if test="queryVO.startDate != null">
            and t3.start_time &gt;= #{queryVO.startDate}
        </if>
        <if test="queryVO.endDate != null">
            and t3.start_time &lt;= #{queryVO.endDate}
        </if>
        order by t.op_type, t.use_category, t4.code
    </select>

</mapper>
