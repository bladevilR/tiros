<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.produce.trainhistory.mapper.BuTrainAssetProduceMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.produce.trainhistory.bean.BuTrainAsset">
        <id column="id" property="id"/>
        <result column="asset_name" property="assetName"/>
        <result column="asset_no" property="assetNo"/>
        <result column="parent_id" property="parentId"/>
        <result column="struct_detail_id" property="structDetailId"/>
        <result column="asset_type_id" property="assetTypeId"/>
        <result column="line_id" property="lineId"/>
        <result column="train_id" property="trainId"/>
        <result column="brand" property="brand"/>
        <result column="vendor" property="vendor"/>
        <result column="model" property="model"/>
        <result column="manuf_no" property="manufNo"/>
        <result column="material_code" property="materialCode"/>
        <result column="asset_code" property="assetCode"/>
        <result column="subjunctive" property="subjunctive"/>
        <result column="turnover" property="turnover"/>
        <result column="material_type_id" property="materialTypeId"/>
        <result column="place_id" property="placeId"/>
        <result column="place_desc" property="placeDesc"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="struct_type" property="structType"/>
        <result column="wbs" property="wbs"/>
        <result column="remark" property="remark"/>
        <result column="sort_no" property="sortNo"/>
        <result column="turnover_asset_id" property="turnoverAssetId"/>
        <result column="short_name" property="shortName"/>
    </resultMap>

    <!-- 设备_子设备映射结果 -->
    <resultMap id="BaseResultMap_Children" type="org.jeecg.modules.produce.trainhistory.bean.BuTrainAsset">
        <id column="id" property="id"/>
        <result column="asset_name" property="assetName"/>
        <result column="asset_no" property="assetNo"/>
        <result column="parent_id" property="parentId"/>
        <result column="struct_detail_id" property="structDetailId"/>
        <result column="asset_type_id" property="assetTypeId"/>
        <result column="line_id" property="lineId"/>
        <result column="train_id" property="trainId"/>
        <result column="brand" property="brand"/>
        <result column="vendor" property="vendor"/>
        <result column="model" property="model"/>
        <result column="manuf_no" property="manufNo"/>
        <result column="material_code" property="materialCode"/>
        <result column="asset_code" property="assetCode"/>
        <result column="subjunctive" property="subjunctive"/>
        <result column="turnover" property="turnover"/>
        <result column="material_type_id" property="materialTypeId"/>
        <result column="place_id" property="placeId"/>
        <result column="place_desc" property="placeDesc"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="struct_type" property="structType"/>
        <result column="wbs" property="wbs"/>
        <result column="remark" property="remark"/>
        <result column="sort_no" property="sortNo"/>
        <result column="turnover_asset_id" property="turnoverAssetId"/>
        <result column="short_name" property="shortName"/>
        <collection property="children" column="id" ofType="org.jeecg.modules.produce.trainhistory.bean.BuTrainAsset"
                    select="selectChildren"/>
    </resultMap>
    <select id="selectChildren" resultMap="BaseResultMap_Children">
        SELECT t.*,
               t1.asset_name AS parentName,
               t2.name       AS assetTypeName,
               t3.place_name AS placeName
        FROM bu_train_asset t
                 LEFT JOIN bu_train_asset t1 ON t1.id = t.parent_id
                 LEFT JOIN bu_train_asset_type t2 ON t2.id = t.asset_type_id
                 LEFT JOIN bu_train_place t3 ON t3.id = t.place_id
        WHERE t.parent_id = #{id}
        ORDER BY t.sort_no, t.wbs
    </select>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, asset_name, asset_no, parent_id, struct_detail_id, asset_type_id, line_id, train_id,
        brand, vendor, model, manuf_no, material_code, asset_code, subjunctive, turnover, material_type_id,
        place_id, place_desc, status, create_time, create_by, update_time, update_by, struct_type, wbs,
        remark, sort_no, turnover_asset_id, short_name
    </sql>


    <select id="selectListByBuTrainAssetQueryVO" resultType="org.jeecg.modules.produce.trainhistory.bean.BuTrainAsset">
        select t.*,
        t1.asset_name as parentName
        from bu_train_asset t
        left join bu_train_asset t1 on t1.id = t.parent_id
        <where>
            <if test="queryVO.trainNo != null and queryVO.trainNo != ''">
                and t.train_id = (select id from bu_train_info where train_no = #{queryVO.trainNo})
            </if>
            <choose>
                <when test="queryVO.parentAssetId != null and queryVO.parentAssetId != ''">
                    and (
                    t.parent_id = #{queryVO.parentAssetId}
                    <if test="queryVO.recurseAsset != null and queryVO.recurseAsset = true">
                        or t.wbs like #{queryVO.parentAssetWbs}||'%'
                    </if>
                    )
                </when>
                <otherwise>
                    <if test="queryVO.structureDetailId != null and queryVO.structureDetailId != ''">
                        and (
                        t.struct_detail_id = #{queryVO.structureDetailId}
                        <if test="queryVO.recurseStructDetail != null and queryVO.recurseStructDetail = true">
                            <if test="queryVO.structureDetailIdList != null and queryVO.structureDetailIdList.size > 0">
                                or ( t.struct_detail_id in
                                <trim suffixOverrides=" OR  t.struct_detail_id  IN()">
                                    <foreach item="item" index="index" collection="queryVO.structureDetailIdList"
                                             open="(" close=")">
                                        <if test="index != 0">
                                            <choose>
                                                <when test="index % 1000 == 999">) OR t.struct_detail_id IN (</when>
                                                <otherwise>,</otherwise>
                                            </choose>
                                        </if>
                                        #{item}
                                    </foreach>
                                </trim>
                                )

                                <!-- or t.struct_detail_id in
                                 <foreach collection="queryVO.structureDetailIdList" item="detailId" open="("
                                          separator=","
                                          close=")">
                                     #{detailId}
                                 </foreach>-->
                            </if>
                        </if>
                        )
                    </if>
                </otherwise>
            </choose>
        </where>
    </select>

    <select id="selectIdListByBuTrainAssetQueryVO" resultType="java.lang.String">
        select t.id
        from bu_train_asset t
        <where>
            <if test="queryVO.trainNo != null and queryVO.trainNo != ''">
                and t.train_id = (select id from bu_train_info where train_no = #{queryVO.trainNo})
            </if>
            <choose>
                <when test="queryVO.parentAssetId != null and queryVO.parentAssetId != ''">
                    and (
                    t.parent_id = #{queryVO.parentAssetId}
                    <if test="queryVO.recurseAsset != null and queryVO.recurseAsset = true">
                        or t.wbs like #{queryVO.parentAssetWbs}||'%'
                    </if>
                    )
                </when>
                <otherwise>
                    <if test="queryVO.structureDetailId != null and queryVO.structureDetailId != ''">
                        and (
                        t.struct_detail_id = #{queryVO.structureDetailId}
                        <if test="queryVO.recurseStructDetail != null and queryVO.recurseStructDetail = true">
                            <if test="queryVO.structureDetailIdList != null and queryVO.structureDetailIdList.size > 0">
                                or ( t.struct_detail_id in
                                <trim suffixOverrides=" OR  t.struct_detail_id  IN()">
                                    <foreach item="item" index="index" collection="queryVO.structureDetailIdList"
                                             open="(" close=")">
                                        <if test="index != 0">
                                            <choose>
                                                <when test="index % 1000 == 999">) OR t.struct_detail_id IN (</when>
                                                <otherwise>,</otherwise>
                                            </choose>
                                        </if>
                                        #{item}
                                    </foreach>
                                </trim>
                                )


                                <!--  or t.struct_detail_id in
                                  <foreach collection="queryVO.structureDetailIdList" item="detailId" open="("
                                           separator=","
                                           close=")">
                                      #{detailId}
                                  </foreach>-->
                            </if>
                        </if>
                        )
                    </if>
                </otherwise>
            </choose>
        </where>
    </select>

    <select id="selectAssetById" resultType="org.jeecg.modules.produce.trainhistory.bean.BuTrainAsset">
        SELECT t.*,
               t1.asset_name AS parentName,
               t2.name       AS assetTypeName,
               t3.place_name AS placeName
        FROM bu_train_asset t
                 LEFT JOIN bu_train_asset t1 ON t1.id = t.parent_id
                 LEFT JOIN bu_train_asset_type t2 ON t2.id = t.asset_type_id
                 LEFT JOIN bu_train_place t3 ON t3.id = t.place_id
        WHERE t.id = #{assetId}
    </select>

    <select id="selectIdListByTrainNoAndStructDetailId" resultType="java.lang.String">
        select id
        from bu_train_asset
        where train_id = (select id from bu_train_info where train_no = #{trainNo})
          and struct_detail_id = #{structDetailId}
        order by wbs
    </select>

</mapper>
