<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.dispatch.workorder.mapper.BuMaterialApplyDispatchMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.dispatch.workorder.bean.BuMaterialApply">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="title" property="title"/>
        <result column="apply_type" property="applyType"/>
        <result column="work_order_id" property="workOrderId"/>
        <result column="train_no" property="trainNo"/>
        <result column="dept_id" property="deptId"/>
        <result column="user_id" property="userId"/>
        <result column="apply_date" property="applyDate"/>
        <result column="ready_status" property="readyStatus"/>
        <result column="status" property="status"/>
        <result column="receive_time" property="receiveTime"/>
        <result column="receive_group_id" property="receiveGroupId"/>
        <result column="receive_user_id" property="receiveUserId"/>
        <result column="depot_id" property="depotId"/>
        <result column="line_id" property="lineId"/>
        <result column="workshop_id" property="workshopId"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="sync_time" property="syncTime"/>
        <result column="sync_result" property="syncResult"/>
        <result column="sync_result_time" property="syncResultTime"/>
        <result column="company_id" property="companyId"/>
    </resultMap>

    <resultMap id="ResultMap_BuMaterialApply_Detail" type="org.jeecg.modules.dispatch.workorder.bean.BuMaterialApply">
        <id column="id" property="id"/>
        <result column="code" property="code"/>
        <result column="title" property="title"/>
        <result column="apply_type" property="applyType"/>
        <result column="work_order_id" property="workOrderId"/>
        <result column="train_no" property="trainNo"/>
        <result column="dept_id" property="deptId"/>
        <result column="user_id" property="userId"/>
        <result column="apply_date" property="applyDate"/>
        <result column="ready_status" property="readyStatus"/>
        <result column="status" property="status"/>
        <result column="receive_time" property="receiveTime"/>
        <result column="receive_group_id" property="receiveGroupId"/>
        <result column="receive_user_id" property="receiveUserId"/>
        <result column="depot_id" property="depotId"/>
        <result column="line_id" property="lineId"/>
        <result column="workshop_id" property="workshopId"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="sync_time" property="syncTime"/>
        <result column="sync_result" property="syncResult"/>
        <result column="sync_result_time" property="syncResultTime"/>
        <result column="company_id" property="companyId"/>
        <collection property="detailList" column="id"
                    ofType="org.jeecg.modules.dispatch.workorder.bean.BuMaterialApplyDetail"
                    select="selectApplyDetailList"/>
    </resultMap>
    <select id="selectApplyDetailList" resultType="org.jeecg.modules.dispatch.workorder.bean.BuMaterialApplyDetail">
        SELECT t1.*,
               t2.code     AS materialTypeCode,
               t2.name     AS materialTypeName,
               t2.spec     AS materialTypeSpec,
               t2.unit     AS materialTypeUnit,
               t4.name     AS warehouseName,
               t5.realname AS confirmUserName,
               t7.realname AS sendUserName
        FROM bu_material_apply_detail t1
                 LEFT JOIN bu_material_type t2 ON t2.id = t1.material_type_id
                 LEFT JOIN bu_material_entry_detail t3 ON t3.id = entry_detail_id
                 LEFT JOIN bu_mtr_warehouse t4 ON t4.id = t3.self_warehouse_id
                 LEFT JOIN sys_user t5 ON t5.id = t1.confirm_user
                 LEFT JOIN sys_user t7 ON t7.id = t1.send_user
        WHERE t1.apply_id = #{id}
    </select>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, code, title, apply_type, work_order_id, train_no, dept_id,
        user_id, apply_date, ready_status, status, receive_time, receive_group_id,
        receive_user_id, depot_id, line_id, workshop_id, remark, create_time,
        create_by, update_time, update_by, sync_time, sync_result, sync_result_time,
        company_id
    </sql>


    <select id="deleteByOrderId">
        delete
        from bu_material_apply
        where work_order_id = #{orderId}
    </select>

    <select id="selectListByOrderIdAndType" resultMap="ResultMap_BuMaterialApply_Detail">
        SELECT
        t.*,
        t1.group_name AS receiveGroupName,
        t2.realname AS receiveUserName,
        t3.order_name AS workOrderName,
        t4.depart_name AS deptName,
        t5.realname AS userName
        FROM bu_material_apply t
        LEFT JOIN bu_mtr_workshop_group t1 ON t1.id = t.receive_group_id
        LEFT JOIN sys_user t2 ON t2.id = t.receive_user_id
        LEFT JOIN bu_work_order t3 ON t3.id = t.work_order_id
        LEFT JOIN sys_depart t4 ON t4.id = t.dept_id
        LEFT JOIN sys_user t5 ON t5.id = t.user_id
        WHERE t.work_order_id = #{orderId}
        <if test="applyType != null">
            and t.apply_type = #{applyType}
        </if>
        order by t.apply_date desc
    </select>

</mapper>
