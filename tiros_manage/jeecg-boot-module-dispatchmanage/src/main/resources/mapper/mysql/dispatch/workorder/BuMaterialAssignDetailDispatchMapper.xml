<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.dispatch.workorder.mapper.BuMaterialAssignDetailDispatchMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.dispatch.workorder.bean.BuMaterialAssignDetail">
        <id column="id" property="id"/>
        <result column="apply_detail_id" property="applyDetailId"/>
        <result column="material_type_id" property="materialTypeId"/>
        <result column="location_wbs" property="locationWbs"/>
        <result column="location_name" property="locationName"/>
        <result column="pallet_id" property="palletId"/>
        <result column="amount" property="amount"/>
        <result column="ebs_wh_code" property="ebsWhCode"/>
        <result column="ebs_wh_child_code" property="ebsWhChildCode"/>
        <result column="trade_no" property="tradeNo"/>
        <result column="price" property="price"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, apply_detail_id, material_type_id, location_wbs, location_name, pallet_id, amount,
        ebs_wh_code, ebs_wh_child_code, trade_no, price
    </sql>

    <delete id="deleteByOrderId">
        delete
        from bu_material_assign_detail
        where apply_detail_id in (select id
                                  from bu_material_apply_detail
                                  where apply_id in (select id from bu_material_apply where work_order_id = #{orderId}))
    </delete>

    <select id="selectListByOrderId" resultType="org.jeecg.modules.dispatch.workorder.bean.BuMaterialAssignDetail">
        select t.*,
               t1.apply_id
        from bu_material_assign_detail t
                 left join bu_material_apply_detail t1 on t1.id = t.apply_detail_id
                 left join bu_material_apply t2 on t2.id = t1.apply_id
        where t2.work_order_id = #{orderId}
    </select>

    <select id="selectListForGroupStockCount"
            resultType="org.jeecg.modules.dispatch.workorder.bean.BuMaterialAssignDetail">
        select t.*,
        t3.train_no,
        t3.order_code as sourceOrderCode
        from bu_material_assign_detail t
        left join bu_material_apply_detail t1 on t1.id = t.apply_detail_id
        left join bu_work_order_material t2 on t2.id = t1.order_material_id
        left join bu_work_order t3 on t3.id = t2.order_id
        where t1.status = 2
        and t1.order_material_id
        <choose>
            <when test="orderMaterialIdList != null and orderMaterialIdList.size > 0">
                in
                <foreach collection="orderMaterialIdList" item="orderMaterialId" open="(" separator="," close=")">
                    #{orderMaterialId}
                </foreach>
            </when>
            <otherwise>
                = '-1'
            </otherwise>
        </choose>
    </select>

</mapper>
