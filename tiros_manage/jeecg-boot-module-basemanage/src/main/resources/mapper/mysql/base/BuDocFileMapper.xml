<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.basemanage.doc.mapper.BuDocFileMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.basemanage.doc.bean.BuDocFile">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="type" property="type"/>
        <result column="savepath" property="savepath"/>
        <result column="file_size" property="fileSize"/>
        <result column="directory_id" property="directoryId"/>
        <result column="directory_type" property="directoryType"/>
        <result column="belonger" property="belonger"/>
        <result column="create_time" property="createTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="company_id" property="companyId"/>
        <result column="workshop_id" property="workshopId"/>
        <result column="line_id" property="lineId"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, name, type, savepath, file_size, directory_id, directory_type, belonger,
        create_time, create_by, update_time, update_by, company_id, workshop_id, line_id
    </sql>


    <select id="listPage" resultType="org.jeecg.modules.basemanage.doc.bean.BuFileAndDirectory">
        <if test="file.showType!=null">
            <if test="file.showType==0">
                select t.* from (
                Select id ,name,type,savepath,file_size,create_time as uploadDate, 1 as isFile ,remark,file_tags as
                fileTags
                from bu_doc_file
                <where>
                    <if test="file.name!=null and file.name!=''">
                        name like concat('%',#{file.name},'%')
                    </if>
                    <if test="file.type!=null and file.type!=''">
                        and type=#{file.type}
                    </if>

                    <if test="file.id!=null and file.id!=''">
                        and directory_id=#{file.id}
                    </if>
                    and status=1
                    <choose>
                        <when test="file.directoryType!=null">
                            <if test="file.directoryType==1 and !file.isAdmin">
                                <if test="file.personId!=null and file.personId!=''">
                                    and ( id in(select obj_id from bu_doc_privilege where
                                    ( target_id=#{file.personId} or target_id=#{file.groupId}
                                    <if test="file.roles!=null">
                                        or target_id in
                                        <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                            #{item}
                                        </foreach>
                                    </if>
                                    )
                                    <if test="file.id!=null and file.id!=''">
                                        and obj_id in (select id from bu_doc_file
                                        where directory_id=#{file.id})
                                    </if>
                                    ) or belonger=#{file.personId} )
                                </if>
                            </if>
                            <if test="file.directoryType==3 and !file.isAdmin ">
                                <if test="file.groupId!=null and file.groupId!=''">
                                    and ( id in(select obj_id from bu_doc_privilege where
                                    ( target_id=#{file.groupId}
                                    <if test="file.roles!=null">
                                        or target_id in
                                        <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                            #{item}
                                        </foreach>
                                    </if>
                                    )
                                    <if test="file.id!=null and file.id!=''">
                                        and obj_id in (select id from bu_doc_file
                                        where directory_id=#{file.id})
                                    </if>
                                    ) or belonger=#{file.groupId} )
                                </if>
                            </if>
                        </when>
                        <otherwise>
                            <if test="!file.isAdmin">
                                and (belonger=#{file.personId} or belonger=#{file.groupId}
                                or directory_type=2
                                or id in(select obj_id from bu_doc_privilege where
                                ( target_id=#{file.personId} or target_id=#{file.groupId}
                                <if test="file.roles!=null">
                                    or target_id in
                                    <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                        #{item}
                                    </foreach>
                                </if>
                                )
                                <if test="file.id!=null and file.id!=''">
                                    and obj_id in (select id from bu_doc_file
                                    where directory_id=#{file.id})
                                </if>
                                )
                                )
                            </if>

                        </otherwise>
                    </choose>
                </where>
                union all
                select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                0 as isFile,remark,null as fileTags
                from bu_doc_directory_person
                <where>
                    <if test="file.name!=null and file.name!=''">
                        name like concat('%',#{file.name},'%')
                    </if>
                    <if test="file.type!=null and file.type!=''">
                        and 1=2
                    </if>
                    <if test="file.id!=null and file.id!=''">
                        and parent_id=#{file.id}
                    </if>
                    and status=1
                    <if test="!file.isAdmin">
                        and ( id in(select obj_id from bu_doc_privilege where
                        ( target_id=#{file.personId}
                        <if test="file.roles!=null">
                            or target_id in
                            <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        )
                        <if test="file.id!=null and file.id!=''">
                            and obj_id in (select id from bu_doc_directory_person where parent_id=#{file.id})
                        </if>
                        )
                        <if test="file.personId!=null and file.personId!=''">
                            or belonger=#{file.personId}
                        </if>
                        )
                    </if>
                </where>

                union all
                select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                0 as isFile,remark,null as fileTags
                from bu_doc_directory_group
                <where>
                    <if test="file.name!=null and file.name!=''">
                        name like concat('%',#{file.name},'%')
                    </if>
                    <if test="file.type!=null and file.type!=''">
                        and 1=2
                    </if>
                    <if test="file.id!=null and file.id!=''">
                        and parent_id=#{file.id}
                    </if>
                    and status=1
                    <if test="!file.isAdmin">
                        and ( id in(select obj_id from bu_doc_privilege where
                        ( target_id=#{file.groupId}
                        <if test="file.roles!=null">
                            or target_id in
                            <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                #{item}
                            </foreach>
                        </if>
                        )
                        <if test="file.id!=null and file.id!=''">
                            and obj_id in (select id from bu_doc_directory_group where parent_id=#{file.id})
                        </if>
                        )
                        <if test="file.groupId!=null and file.groupId!=''">
                            or belonger=#{file.groupId}
                        </if>
                        )
                    </if>
                </where>
                union all
                select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                0 as isFile,remark,null as fileTags
                from bu_doc_directory
                <where>
                    <if test="file.name!=null and file.name!=''">
                        name like concat('%',#{file.name},'%')
                    </if>
                    <if test="file.type!=null and file.type!=''">
                        and 1=2
                    </if>
                    <if test="file.id!=null and file.id!=''">
                        and parent_id=#{file.id}
                    </if>
                    and status=1
                    <if test="!file.isAdmin">
                        and ( id in(select obj_id from bu_doc_privilege
                        <where>
                            <if test="file.roles!=null">
                                target_id in
                                <foreach collection="file.roles" item="item" open="(" separator=","
                                         close=")">
                                    #{item}
                                </foreach>
                            </if>
                        </where>

                        ) )
                    </if>
                </where>
                ) t order by t.uploadDate Desc
            </if>
            <if test="file.showType==1">
                <choose>
                    <when test="file.directoryType!=null">
                        select t.* from (
                        <if test="file.directoryType==1">
                            <if test="file.personId!=null and file.personId!=''">
                                select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                                0 as isFile,remark
                                from bu_doc_directory_person
                                <where>
                                    <if test="file.name!=null and file.name!=''">
                                        name like concat('%',#{file.name},'%')
                                    </if>
                                    <if test="file.type!=null and file.type!=''">
                                        and 1=2
                                    </if>
                                    <if test="file.id!=null and file.id!=''">
                                        and parent_id=#{file.id}
                                    </if>
                                    and status=1

                                    <if test="!file.isAdmin">
                                        and ( id in(select obj_id from bu_doc_privilege where
                                        ( target_id=#{file.personId}
                                        <if test="file.roles!=null">
                                            or target_id in
                                            <foreach collection="file.roles" item="item" open="(" separator=","
                                                     close=")">
                                                #{item}
                                            </foreach>
                                        </if>
                                        )
                                        and obj_id in (select id from bu_doc_directory_person where
                                        parent_id=#{file.id}))
                                        <if test="file.personId!=null and file.personId!=''">
                                            or belonger=#{file.personId}
                                        </if>
                                        )
                                    </if>
                                </where>
                            </if>
                        </if>
                        <if test="file.directoryType==3 ">
                            <if test="file.groupId!=null and file.groupId!=''">
                                select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                                0 as isFile,remark
                                from bu_doc_directory_group
                                <where>
                                    <if test="file.name!=null and file.name!=''">
                                        name like concat('%',#{file.name},'%')
                                    </if>
                                    <if test="file.type!=null and file.type!=''">
                                        and 1=2
                                    </if>

                                    <if test="file.id!=null and file.id!=''">
                                        and parent_id=#{file.id}
                                    </if>
                                    and status=1
                                    <if test="!file.isAdmin">
                                        and ( id in(select obj_id from bu_doc_privilege where
                                        ( target_id=#{file.groupId}
                                        <if test="file.roles!=null">
                                            or target_id in
                                            <foreach collection="file.roles" item="item" open="(" separator=","
                                                     close=")">
                                                #{item}
                                            </foreach>
                                        </if>
                                        )
                                        and obj_id in (select id from bu_doc_directory_group where parent_id=#{file.id})
                                        )
                                        <if test="file.groupId!=null and file.groupId!=''">
                                            or belonger=#{file.groupId}
                                        </if>
                                        )
                                    </if>
                                </where>
                            </if>
                        </if>
                        <if test="file.directoryType==2">
                            select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                            0 as isFile,remark
                            from bu_doc_directory
                            <where>
                                <if test="file.name!=null and file.name!=''">
                                    name like concat('%',#{file.name},'%')
                                </if>
                                <if test="file.type!=null and file.type!=''">
                                    and 1=2
                                </if>
                                <if test="file.id!=null and file.id!=''">
                                    and parent_id=#{file.id}
                                </if>
                                and status=1
                                <if test="!file.isAdmin">
                                    and ( id in(select obj_id from bu_doc_privilege
                                    <where>
                                        <if test="file.roles!=null">
                                            target_id in
                                            <foreach collection="file.roles" item="item" open="(" separator=","
                                                     close=")">
                                                #{item}
                                            </foreach>
                                        </if>
                                    </where>

                                    ) )
                                </if>
                            </where>
                        </if>
                        ) t order by t.uploadDate Desc
                    </when>
                    <otherwise>
                        select t.* from (
                        select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                        0 as isFile,remark
                        from bu_doc_directory_person
                        <where>
                            <if test="file.name!=null and file.name!=''">
                                name like concat('%',#{file.name},'%')
                            </if>
                            <if test="file.type!=null and file.type!=''">
                                and 1=2
                            </if>
                            <if test="file.id!=null and file.id!=''">
                                and parent_id=#{file.id}
                            </if>
                            and status=1
                            <if test="!file.isAdmin">
                                and ( id in(select obj_id from bu_doc_privilege where (
                                target_id=#{file.personId}
                                <if test="file.roles!=null">
                                    or target_id in
                                    <foreach collection="file.roles" item="item" open="(" separator=","
                                             close=")"></foreach>
                                </if>
                                #{item}
                                )
                                and obj_id in (select id from bu_doc_directory_person where parent_id=#{file.id}))
                                <if test="file.personId!=null and file.personId!=''">
                                    or belonger=#{file.personId}
                                </if>
                                )
                            </if>
                        </where>
                        union all
                        select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                        0 as isFile,remark
                        from bu_doc_directory_group
                        <where>
                            <if test="file.name!=null and file.name!=''">
                                name like concat('%',#{file.name},'%')
                            </if>
                            <if test="file.type!=null and file.type!=''">
                                and 1=2
                            </if>
                            <if test="file.id!=null and file.id!=''">
                                and parent_id=#{file.id}
                            </if>
                            and status=1
                            <if test="!file.isAdmin">
                                and ( id in(select obj_id from bu_doc_privilege where (
                                target_id=#{file.groupId}
                                <if test="file.roles!=null">
                                    or target_id in
                                    <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                        #{item}
                                    </foreach>
                                </if>
                                )
                                and obj_id in (select id from bu_doc_directory_group where parent_id=#{file.id}))
                                <if test="file.groupId!=null and file.groupId!=''">
                                    or belonger=#{file.groupId}
                                </if>
                                )
                            </if>
                        </where>
                        union all
                        select id,name ,'文件夹' as type,''as savepath,0 as file_size,create_time as uploadDate,
                        0 as isFile,remark
                        from bu_doc_directory
                        <where>
                            <if test="file.name!=null and file.name!=''">
                                name like concat('%',#{file.name},'%')
                            </if>
                            <if test="file.type!=null and file.type!=''">
                                and 1=2
                            </if>
                            <if test="file.id!=null and file.id!=''">
                                and parent_id=#{file.id}
                            </if>
                            and status=1
                            <if test="!file.isAdmin">
                                and ( id in(select obj_id from bu_doc_privilege
                                <where>
                                    <if test="file.roles!=null">
                                        target_id in
                                        <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                            #{item}
                                        </foreach>
                                    </if>
                                </where>
                                ) )
                            </if>
                        </where>
                        ) t order by t.uploadDate Desc
                    </otherwise>
                </choose>
            </if>
            <if test="file.showType==2">
                Select id ,name,type,savepath,file_size,create_time as uploadDate, 1 as isFile ,remark,file_tags as
                fileTags
                from bu_doc_file
                <where>
                    <if test="file.name!=null and file.name!=''">
                        name like concat('%',#{file.name},'%')
                    </if>
                    <if test="file.type!=null and file.type!=''">
                        and type=#{file.type}
                    </if>
                    <if test="file.id!=null and file.id!=''">
                        and directory_id=#{file.id}
                    </if>
                    and status=1
                    <choose>
                        <when test="file.directoryType!=null">
                            <if test="file.directoryType==1 and !file.isAdmin">
                                <if test="file.personId!=null and file.personId!=''">
                                    and ( id in(select obj_id from bu_doc_privilege where
                                    ( target_id=#{file.personId} or target_id=#{file.groupId}
                                    <if test="file.roles!=null">
                                        or target_id in
                                        <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                            #{item}
                                        </foreach>
                                    </if>

                                    )
                                    <if test="file.id!=null and file.id!=''">
                                        and obj_id in (select id from bu_doc_file
                                        where directory_id=#{file.id})
                                    </if>
                                    ) or belonger=#{file.personId} )
                                </if>
                            </if>
                            <if test="file.directoryType==3 and !file.isAdmin">
                                <if test="file.groupId!=null and file.groupId!=''">
                                    and ( id in(select obj_id from bu_doc_privilege where
                                    ( target_id=#{file.groupId}
                                    <if test="file.roles!=null">
                                        or target_id in
                                        <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                            #{item}
                                        </foreach>
                                    </if>
                                    )
                                    <if test="file.id!=null and file.id!=''">
                                        and obj_id in (select id from bu_doc_file
                                        where directory_id=#{file.id})
                                    </if>
                                    ) or belonger=#{file.groupId} )
                                </if>
                            </if>
                        </when>
                        <otherwise>
                            <if test="!file.isAdmin">
                                and (belonger=#{file.personId} or belonger=#{file.groupId}
                                or directory_type=2
                                or id in(select obj_id from bu_doc_privilege where
                                ( target_id=#{file.personId} or target_id=#{file.groupId}
                                <if test="file.roles!=null">
                                    or target_id in
                                    <foreach collection="file.roles" item="item" open="(" separator="," close=")">
                                        #{item}
                                    </foreach>
                                </if>
                                )
                                <if test="file.id!=null and file.id!=''">
                                    and obj_id in (select id from bu_doc_file
                                    where directory_id=#{file.id})
                                </if>
                                )
                                )
                            </if>
                        </otherwise>
                    </choose>
                </where>
                order by uploadDate desc
            </if>
        </if>
    </select>

    <select id="selectFileType" resultType="string">
        select type
        from bu_doc_file
        group by type
    </select>

</mapper>
