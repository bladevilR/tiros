(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-b27a310c"],{"5a39":function(t,e,a){},"7ebc":function(t,e){t.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAeCAIAAADhM9qrAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDIwLTExLTMwVDE1OjIyOjI2KzA4OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTExLTMwVDE1OjIyOjI2KzA4OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyMC0xMS0zMFQxNToyMjoyNiswODowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpiNWMxODI1Zi0wODgwLTAxNDUtOTU1OS1kOTgzNGViZmI3NTIiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo3NzZhNzg4ZS1iZDI2LTlhNDYtOTI0Yi03N2FiZGJiNzZlMjMiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo3Y2QyYzc3Ni0yODA4LTcyNDMtYWYzNi00OGU5NjgwMzIzMWEiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjdjZDJjNzc2LTI4MDgtNzI0My1hZjM2LTQ4ZTk2ODAzMjMxYSIgc3RFdnQ6d2hlbj0iMjAyMC0xMS0zMFQxNToyMjoyNiswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpiNWMxODI1Zi0wODgwLTAxNDUtOTU1OS1kOTgzNGViZmI3NTIiIHN0RXZ0OndoZW49IjIwMjAtMTEtMzBUMTU6MjI6MjYrMDg6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5LsvJyAAAAMElEQVRYw+3OQREAAAQAMFro/xWSGu5sCZbTFfeklpaWlpaWlpaWlpaWlpaW1t/WAhKuNNu0XXgrAAAAAElFTkSuQmCC"},"9b1e":function(t,e,a){t.exports=a.p+"img/workshop_bg.7b3c9b27.jpg"},edcd:function(t,e,a){"use strict";a("5a39")},ef2b:function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t._self._c;return e("na-splitter",{staticStyle:{border:"1px dotted #cccccc"},attrs:{"default-size":250}},[e("div",{staticStyle:{height:"calc(100vh - 122px)","padding-right":"5px"},attrs:{slot:"left-panel"},slot:"left-panel"},[e("a-collapse",{model:{value:t.activeKey,callback:function(e){t.activeKey=e},expression:"activeKey"}},[e("a-collapse-panel",{key:"1",attrs:{header:"功能区域"}},[e("div",{staticClass:"btn-div"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.openFile}},[t._v(" 修改背景 "),e("input",{ref:"file",staticStyle:{display:"none"},attrs:{type:"file"},on:{change:t.bgFileChange}})])],1),e("div",{staticClass:"btn-div"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.clearCanvas}},[t._v(" 清除所有 ")])],1),e("div",{staticClass:"btn-div"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.saveSetting}},[t._v(" 保存 ")])],1),e("div",{staticClass:"btn-div"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.closeWindow}},[t._v(" 关闭 ")])],1)]),e("a-collapse-panel",{key:"2",attrs:{header:"工位列表(拖动到右边)"}},[e("div",{staticClass:"listWorkStation"},t._l(t.stationList,(function(i){return e("div",{key:i.id,staticClass:"selectItem",attrs:{draggable:"true",type:"station",id:i.id,code:i.stationNo,name:i.name},on:{dragstart:t.dragStart}},[e("div",{staticClass:"logo"},[e("img",{attrs:{src:a("fba6")}})]),e("div",{staticClass:"title"},[t._v(" ["+t._s(i.stationNo)+"]-"+t._s(i.name)+" ")]),e("div",{staticStyle:{clear:"both"}})])})),0)]),e("a-collapse-panel",{key:"3",attrs:{header:"股道区域(拖动到右边)"}},[e("div",{staticClass:"listWorkStation"},t._l(t.trackList,(function(i){return e("div",{key:i.id,staticClass:"selectItem",attrs:{draggable:"true",type:"track",id:i.id,code:i.code,name:i.name},on:{dragstart:t.dragStart}},[e("div",{staticClass:"logo"},[e("img",{attrs:{src:a("7ebc")}})]),e("div",{staticClass:"title"},[t._v(" "+t._s(i.name)+" ")]),e("div",{staticStyle:{clear:"both"}})])})),0)])],1)],1),e("div",{ref:"rightPanel",staticStyle:{height:"calc(100vh - 25px)",position:"relative"},attrs:{slot:"right-panel"},on:{contextmenu:function(e){return e.stopPropagation(),t.onContextmenu.apply(null,arguments)}},slot:"right-panel"},[e("canvas",{ref:"myCanvas",attrs:{id:"myCanvas"}}),e("div",{ref:"hoverPop",staticClass:"hoverPop"},[t.hoverItem?e("div",[t._v(" "+t._s(t.hoverItem.code)+"-"+t._s(t.hoverItem.name)+" ")]):t._e()]),e("div",{ref:"contextMenu",staticClass:"contextMenu"},[e("div",{staticClass:"btnDiv"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.deleteObject}},[t._v(" 删除 ")])],1),e("div",{staticClass:"btnDiv"},[e("a-button",{attrs:{type:"link",block:""},on:{click:t.changeImage}},[t._v(" 改变图片 ")])],1)])])])},n=[],s=a("7a94"),c=a("8fad"),o=a("e18e");s["fabric"].NamedImage=s["fabric"].util.createClass(s["fabric"].Image,{type:"named-image",initialize:function(t,e){this.callSuper("initialize",t,e),e&&this.set("name",e.name)&&this.set("id",e.id)&&this.set("code",e.code)&&this.set("iType",e.iType)},toObject:function(){return s["fabric"].util.object.extend(this.callSuper("toObject"),{id:this.id,code:this.code,name:this.name,iType:this.iType})}}),s["fabric"].NamedImage.fromObject=function(t,e){s["fabric"].util.loadImage(t.src,(function(a){e&&e(new s["fabric"].NamedImage(a,t))}))};var r={name:"StationMap",components:{NaSplitter:o["default"]},props:["visible","depotId","workshopId"],data:function(){return{zoom:1,changed:!1,activeKey:1,stationList:[],trackList:[],imgAllow:["jpeg","jpg","gif","png"],canvas:null,dragItem:null,hoverItem:null,contextObj:null,imgSize:{w:30,h:30},workShop:null}},mounted:function(){var t=this;this.loadTracks(),this.loadStationList(),setTimeout((function(){var e=t.$refs.rightPanel.clientWidth,a=t.$refs.rightPanel.clientHeight;t.$refs.myCanvas.width=e,t.$refs.myCanvas.height=a,t.canvas=new s["fabric"].Canvas("myCanvas"),t.canvas.on("drop",t.dropImage),t.canvas.on("mouse:over",t.mouseHover),t.canvas.on("mouse:out",t.mouseOut),t.canvas.on("mouse:down",t.onMouseDown),t.canvas.on("object:moved",(function(){t.changed=!0})),t.loadWorkshop()}),300)},methods:{saveSetting:function(){var t=this;this.workShop.graphAddress=JSON.stringify(this.canvas.toJSON()),Object(c["Fd"])(this.workShop).then((function(e){e.success?(t.$message.success("保存成功"),t.changed=!1):t.$message.error("保存失败")}))},loadWorkshop:function(){var t=this;Object(c["yc"])(this.workshopId).then((function(e){e.success?(t.workShop=e.result,t.workShop.graphAddress?t.canvas.loadFromJSON(t.workShop.graphAddress,(function(){t.zoomBgToFitCanvas()})):t.setBackgroundImage(a("9b1e"))):t.setBackgroundImage(a("9b1e"))})).catch((function(e){t.setBackgroundImage(a("9b1e"))}))},loadTracks:function(){var t=this;Object(c["hc"])({depotId:this.depotId,pageNo:1,pageSize:1e3}).then((function(e){e.success&&(t.trackList=e.result.records)}))},loadStationList:function(){var t=this;Object(c["ec"])({id:this.workshopId,pageNo:1,pageSize:1e3}).then((function(e){e.success&&(t.stationList=e.result.records)}))},openFile:function(){this.$refs.file.dispatchEvent(new MouseEvent("click"))},bgFileChange:function(t){var e=this,a=t.target.files;if(null!=a&&0!==a.length){var i="";try{var n=a[0].name.split(".");i=n[n.length-1]}catch(c){i=""}if(""===i||this.imgAllow.indexOf(i)<0)this.$message.error("不是有效的图片文件,只支持"+this.imgAllow.join(",")+"图片文件");else{var s=new FileReader;s.onload=function(t){var a=t.target.result;e.changed=!0,e.setBackgroundImage(a)},s.readAsDataURL(a[0])}}},setBackgroundImage:function(t){var e=this;s["fabric"].Image.fromURL(t,(function(t){var a=t.height/t.width,i=e.canvas.width/t.width,n=e.canvas.width*a/t.height;e.canvas.setBackgroundImage(t,e.canvas.renderAll.bind(e.canvas),{originX:"left",originY:"top",left:0,top:0,scaleX:i,scaleY:n},{crossOrigin:"anonymous"})}))},dragStart:function(t){if(!t.target.children[0]||!t.target.children[0].children[0])return this.dragItem=null,!1;var e=t.target.children[0].children[0];this.dragItem={id:t.target.attributes["id"].value,code:t.target.attributes["code"].value,name:t.target.attributes["name"].value,type:t.target.attributes["type"].value,img:e}},dropImage:function(t){var e=this;if(this.changed=!0,this.dragItem){var a=t.e,i=a.offsetX,n=a.offsetY;this.checkObjectId(this.dragItem.id)?this.$message.error(this.dragItem.name+"已经存在了，不能重复创建"):s["fabric"].util.loadImage(this.dragItem.img.src,(function(t){var a=null;if("station"===e.dragItem.type){var c=new s["fabric"].NamedImage(t,{top:0,left:0,width:e.dragItem.img.naturalWidth,height:e.dragItem.img.naturalHeight,scaleX:e.imgSize.w/e.dragItem.img.naturalWidth,scaleY:e.imgSize.h/e.dragItem.img.naturalHeight,id:e.dragItem.id,code:e.dragItem.code,name:e.dragItem.name,iType:e.dragItem.type});c.set("selectable",!1);var o=2-e.zoom,r=n-e.imgSize.h/2.5,l=i-e.imgSize.w/2.5;e.zoom<1&&(r=n*o+e.imgSize.h/2.5,l=i*o+e.imgSize.w/2.5),a=new s["fabric"].Group([c],{left:l,top:r})}else if("track"===e.dragItem.type){var d=new s["fabric"].NamedImage(t,{top:0,left:20,width:800,height:30,backgroundColor:"#e3d3d3",scaleX:1,scaleY:1,id:e.dragItem.id,code:e.dragItem.code,name:e.dragItem.name,iType:e.dragItem.type});d.set("selectable",!1);var h=new s["fabric"].Text(e.dragItem.name,{top:7,left:-26,fontSize:15});h.set("selectable",!1),a=new s["fabric"].Group([d,h],{left:i-41,top:n-15})}e.canvas.add(a),e.dragItem=null}))}},mouseHover:function(t){var e=this.$refs.hoverPop;if(e)if(t.target){var a=t.e.offsetY+10,i=t.e.offsetX+10;if(t.target._objects&&t.target._objects.length>0){var n=t.target._objects[0];this.hoverItem={id:n.id,code:n.code,name:n.name},e.style.left=i+"px",e.style.top=a+"px",e.style.display="block"}}else this.hoverItem=null,e.style.display="none"},mouseOut:function(t){var e=this.$refs.hoverPop;e&&t.target&&(e.style.display="none")},onContextmenu:function(t){var e=this.$refs.hoverPop;e&&(e.style.display="none");var a=this.canvas.findTarget(t,!1);if(a&&a._objects&&a._objects.length>0){this.contextObj=a;var i=t.offsetY+10,n=t.offsetX+10;this.$refs.contextMenu.style.left=n+"px",this.$refs.contextMenu.style.top=i+"px",this.$refs.contextMenu.style.display="block"}t.preventDefault()},deleteObject:function(){if(this.contextObj){this.canvas.remove(this.contextObj),this.contextObj=null;var t=this.$refs.contextMenu;t&&(t.style.display="none"),this.changed=!0}},changeImage:function(){var t=this;if(this.contextObj&&"group"===this.contextObj.get("type")){var e=this.contextObj._objects[0];if("named-image"===e.get("type")){var i=a("ffc6"),n=a("fbd7");e.getSrc(!1).indexOf(i)>=0&&(i=n),s["fabric"].util.loadImage(i,(function(a){e.scaleX=1,e.scaleY=1;var i=t.imgSize.w/a.naturalWidth,n=t.imgSize.w/a.naturalHeight;e.setElement(a,{scaleX:i,scaleY:n}),t.canvas.renderAll()}))}}},onMouseDown:function(t){var e=this.$refs.hoverPop;e&&(e.style.display="none");var a=this.$refs.contextMenu;a&&(a.style.display="none"),this.hoverItem=null},checkObjectId:function(t){var e=this,a=!1;return this.canvas.forEachObject((function(i){e.checkIdEqual(i,t)&&(a=!0)})),a},checkIdEqual:function(t,e){if("group"===t.get("type")){for(var a=!1,i=0;i<t._objects.length;i++)if(a=this.checkIdEqual(t._objects[i],e),a)break;return a}return"named-image"===t.get("type")&&t.id===e},testCanvas:function(){},zoomBgToFitCanvas:function(){this.canvas.setZoom(1),this.canvas.absolutePan({x:0,y:0});var t=this.canvas.backgroundImage.width*this.canvas.backgroundImage.scaleX,e=this.canvas.width/t;this.zoom=e;var a=new s["fabric"].Point(0,0);this.canvas.zoomToPoint(a,e)},clearCanvas:function(){var t=this;this.canvas.forEachObject((function(e){t.canvas.remove(e)})),this.changed=!0},closeWindow:function(){var t=this;this.changed?this.$confirm({content:"你的设置已经修改，是否放弃保存？",onOk:function(){t.changed=!1,t.$emit("update:visible",!1)},onCancel:function(){}}):(this.changed=!1,this.$emit("update:visible",!1))},strLen:function(t){for(var e=0,a=0;a<t.length;a++)t.charCodeAt(a)>127||94==t.charCodeAt(a)?e+=2:e++;return e}}},l=r,d=(a("edcd"),a("2877")),h=Object(d["a"])(l,i,n,!1,null,"4444908d",null);e["default"]=h.exports},fba6:function(t,e,a){t.exports=a.p+"img/station_blue.32a75355.png"},fbd7:function(t,e,a){t.exports=a.p+"img/station_yellow.aa6868e0.png"}}]);