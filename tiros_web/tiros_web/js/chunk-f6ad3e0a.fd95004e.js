(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-f6ad3e0a","chunk-149eedb6","chunk-be16a272"],{1175:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("a-modal",{attrs:{width:"90%",visible:e.visible,confirmLoading:e.confirmLoading,cancelText:"关闭",bodyStyle:{height:"60vh"},destroyOnClose:!0},on:{ok:e.handleOk,cancel:e.handleCancel}},[e._t("title",(function(){return[t("div",{staticClass:"limitTitle"},[e._v("上级结构选择")])]})),t("div",{staticClass:"limitHeight"},[t("vxe-table",{ref:"listTable",attrs:{border:"","row-id":"id",align:e.allAlign,data:e.tableData,"show-overflow":"ellipsis","edit-config":{trigger:"manual",mode:"row"},"tree-config":{lazy:!0,children:"children",hasChild:"hasChildren",loadMethod:e.loadChildrenMethod}}},[e.multiple?t("vxe-table-column",{attrs:{type:"checkbox",width:"40"}}):t("vxe-table-column",{attrs:{type:"radio",width:"5%"}}),t("vxe-table-column",{attrs:{field:"name",title:"名称","tree-node":""}}),t("vxe-table-column",{attrs:{field:"code",title:"编码",width:"15%"}}),t("vxe-table-column",{attrs:{field:"status_dictText",title:"状态",width:"10%"}}),t("vxe-table-column",{attrs:{field:"structType_dictText",title:"类型",width:"10%"}}),t("vxe-table-column",{attrs:{field:"placeCode",title:"位置编码",width:"15%"}}),t("vxe-table-column",{attrs:{field:"placeDesc",title:"位置描述",width:"15%"}})],1)],1)],2)},r=[],l=a("8fad"),o={name:"SelectParent",props:{trainStructId:{type:String,default:""},multiple:{type:Boolean,default:!0}},data:function(){return{queryParam:{trainStructId:"",id:""},allAlign:"center",tableData:[],selectTreeNode:[],visible:!1,confirmLoading:!1}},methods:{showModal:function(){this.visible=!0,this.queryParam.trainStructId=this.trainStructId,this.findList()},handleOk:function(){var e=[];this.multiple?e=this.$refs.listTable.getCheckboxRecords():this.$refs.listTable.getRadioRecord()&&e.push(this.$refs.listTable.getRadioRecord()),this.$emit("ok",e),this.close()},handleCancel:function(){this.close()},close:function(){this.$emit("close"),this.visible=!1,this.queryParam.id=""},findList:function(e){var t=this;this.loading=!0,Object(l["pc"])(this.queryParam).then((function(e){e.success&&(t.loading=!1,t.tableData=e.result)}))},loadChildrenMethod:function(e){var t=this,a=e.row;return this.queryParam.id=a.id,new Promise((function(e){Object(l["pc"])(t.queryParam).then((function(a){a.success?e(a.result):t.$message.error("".concat(a.message))}))}))}}},n=o,s=(a("a743"),a("2877")),c=Object(s["a"])(n,i,r,!1,null,"286ea981",null);t["default"]=c.exports},"6b57":function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("a-modal",{attrs:{title:e.title,width:1200,visible:e.visible,confirmLoading:e.confirmLoading,maskClosable:!1,bodyStyle:{maxHeight:"70vh",overflowY:"auto"}},on:{ok:e.handleOk,cancel:e.handleCancel}},[t("a-spin",{attrs:{spinning:e.confirmLoading}},[t("a-alert",{staticStyle:{"margin-bottom":"12px"},attrs:{type:"info","show-icon":"",message:"支持从车辆结构选择并自动填充，也支持手动编辑；线别、位置支持多选。"}}),t("a-form-model",{ref:"form",attrs:{model:e.model,rules:e.validatorRules,"label-col":{span:6},"wrapper-col":{span:16}}},[t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"车型",prop:"trainType"}},[t("a-input",{attrs:{placeholder:"默认电客车，也可手动编辑"},model:{value:e.model.trainType,callback:function(t){e.$set(e.model,"trainType",t)},expression:"model.trainType"}})],1)],1),t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"编码",prop:"bomCode"}},[t("a-input",{attrs:{placeholder:"请输入编码"},model:{value:e.model.bomCode,callback:function(t){e.$set(e.model,"bomCode",t)},expression:"model.bomCode"}})],1)],1),t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"BOM名称",prop:"bomName"}},[t("a-input",{attrs:{placeholder:"请输入BOM名称"},model:{value:e.model.bomName,callback:function(t){e.$set(e.model,"bomName",t)},expression:"model.bomName"}})],1)],1)],1),t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:12}},[t("a-form-model-item",{attrs:{label:"线别(可多选)"}},[t("a-select",{attrs:{mode:"multiple",placeholder:"请选择线别",allowClear:""},model:{value:e.lineValues,callback:function(t){e.lineValues=t},expression:"lineValues"}},e._l(e.lineOptions,(function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v(e._s(a))])})),1)],1)],1),t("a-col",{attrs:{span:12}},[t("a-form-model-item",{attrs:{label:"位置(可多选)"}},[t("a-select",{attrs:{mode:"multiple",placeholder:"请选择位置",allowClear:""},model:{value:e.positionValues,callback:function(t){e.positionValues=t},expression:"positionValues"}},e._l(e.positionOptions,(function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v(e._s(a))])})),1)],1)],1)],1),t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"所属系统"}},[t("a-input",{attrs:{placeholder:"请输入所属系统"},model:{value:e.model.system,callback:function(t){e.$set(e.model,"system",t)},expression:"model.system"}})],1)],1),t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"二级模块"}},[t("a-input",{attrs:{placeholder:"请输入二级模块"},model:{value:e.model.moduleLevel2,callback:function(t){e.$set(e.model,"moduleLevel2",t)},expression:"model.moduleLevel2"}})],1)],1),t("a-col",{attrs:{span:8}},[t("a-form-model-item",{attrs:{label:"三级模块"}},[t("a-input",{attrs:{placeholder:"选填"},model:{value:e.model.moduleLevel3,callback:function(t){e.$set(e.model,"moduleLevel3",t)},expression:"model.moduleLevel3"}})],1)],1)],1),t("a-row",[t("a-col",{attrs:{span:24}},[t("a-form-model-item",{attrs:{label:"结构关联","label-col":{span:3},"wrapper-col":{span:20}}},[t("a-space",[t("a-select",{staticStyle:{width:"260px"},attrs:{placeholder:"请选择车辆结构",allowClear:"",showSearch:"",optionFilterProp:"children"},on:{change:e.onStructChange},model:{value:e.selectedStructId,callback:function(t){e.selectedStructId=t},expression:"selectedStructId"}},e._l(e.structOptions,(function(a){return t("a-select-option",{key:a.id,attrs:{value:a.id}},[e._v(" "+e._s(a.name)+" ")])})),1),t("a-button",{attrs:{disabled:!e.selectedStructId},on:{click:e.openStructDetailSelect}},[e._v("从结构明细选择并填充")])],1)],1)],1)],1),t("a-row",[t("a-col",{attrs:{span:24}},[t("a-form-model-item",{attrs:{label:"爆炸图URL","label-col":{span:3},"wrapper-col":{span:20}}},[t("a-space",{staticStyle:{width:"100%"}},[t("a-input",{staticStyle:{width:"520px"},attrs:{placeholder:"请输入爆炸图URL或上传图片"},model:{value:e.model.explosionDiagram,callback:function(t){e.$set(e.model,"explosionDiagram",t)},expression:"model.explosionDiagram"}}),t("j-image-upload",{attrs:{text:"上传爆炸图",isMultiple:!1,bizPath:"/quota-bom/explosion"},model:{value:e.model.explosionDiagram,callback:function(t){e.$set(e.model,"explosionDiagram",t)},expression:"model.explosionDiagram"}})],1)],1)],1)],1),t("a-row",[t("a-col",{attrs:{span:24}},[t("a-form-model-item",{attrs:{label:"关联物资","label-col":{span:3},"wrapper-col":{span:20}}},[t("a-space",{staticStyle:{width:"100%"}},[t("a-input",{staticStyle:{width:"520px"},attrs:{value:e.materialSummary,placeholder:"请选择关联物资",disabled:""}}),t("a-button",{on:{click:e.openMaterialSelect}},[e._v("选择物资")]),t("a-button",{attrs:{disabled:0===e.selectedMaterialRows.length},on:{click:e.clearSelectedMaterials}},[e._v("清空")])],1),e.selectedMaterialRows.length>0?t("div",{staticClass:"material-tag-list"},e._l(e.selectedMaterialRows,(function(a){return t("a-tag",{key:a.id,staticStyle:{"margin-top":"6px"}},[e._v(" "+e._s(a.code?"".concat(a.code," - ").concat(a.name):a.name)+" ")])})),1):e._e()],1)],1)],1),t("a-row",[t("a-col",{attrs:{span:24}},[t("a-form-model-item",{attrs:{label:"部件明细","label-col":{span:3},"wrapper-col":{span:20}}},[t("vxe-table",{attrs:{border:"",size:"mini","max-height":"280",data:e.partRows,"edit-config":{trigger:"click",mode:"cell"}}},[t("vxe-table-column",{attrs:{type:"seq",width:"50",title:"#"}}),t("vxe-table-column",{attrs:{field:"partNo",title:"件号","min-width":"110","edit-render":{name:"input"}}}),t("vxe-table-column",{attrs:{field:"name",title:"名称","min-width":"120","edit-render":{name:"input"}}}),t("vxe-table-column",{attrs:{field:"spec",title:"规格型号","min-width":"120","edit-render":{name:"input"}}}),t("vxe-table-column",{attrs:{field:"drawingQty",title:"图上数量",width:"90","edit-render":{name:"$input",props:{type:"number",min:0}}}}),t("vxe-table-column",{attrs:{field:"trainQty",title:"1列车数量",width:"95","edit-render":{name:"$input",props:{type:"number",min:0}}}}),t("vxe-table-column",{attrs:{field:"materialCode",title:"物资编码","min-width":"110","edit-render":{name:"input"}}}),t("vxe-table-column",{attrs:{field:"reqFirstFrame",title:"一架",width:"70","edit-render":{name:"$checkbox"}}}),t("vxe-table-column",{attrs:{field:"reqFirstMajor",title:"一大",width:"70","edit-render":{name:"$checkbox"}}}),t("vxe-table-column",{attrs:{field:"reqSecondFrame",title:"二架",width:"70","edit-render":{name:"$checkbox"}}}),t("vxe-table-column",{attrs:{field:"reqSecondMajor",title:"二大",width:"70","edit-render":{name:"$checkbox"}}}),t("vxe-table-column",{attrs:{field:"reqThirdFrame",title:"三架",width:"70","edit-render":{name:"$checkbox"}}}),t("vxe-table-column",{attrs:{title:"操作",width:"80",fixed:"right"},scopedSlots:e._u([{key:"default",fn:function(a){return[t("a",{on:{click:function(t){return e.removePartRow(a.rowIndex)}}},[e._v("删除")])]}}])})],1),t("a-space",{staticStyle:{"margin-top":"8px"}},[t("a-button",{attrs:{size:"small"},on:{click:e.addPartRow}},[e._v("新增明细行")]),t("a-button",{attrs:{size:"small"},on:{click:e.normalizePartRows}},[e._v("清理空行")])],1)],1)],1)],1),t("a-row",[t("a-col",{attrs:{span:24}},[t("a-form-model-item",{attrs:{label:"备注","label-col":{span:3},"wrapper-col":{span:20}}},[t("a-textarea",{attrs:{rows:2,placeholder:"请输入备注"},model:{value:e.model.remark,callback:function(t){e.$set(e.model,"remark",t)},expression:"model.remark"}})],1)],1)],1)],1)],1),t("select-parent",{ref:"structDetailSelect",attrs:{"train-struct-id":e.selectedStructId,multiple:!1},on:{ok:e.onStructDetailSelected}}),t("material-list",{ref:"materialSelect",attrs:{multiple:!0,mode:[1],typeCodeList:[]},on:{ok:e.onMaterialSelected}})],1)},r=[],l=a("8fad"),o=a("1175"),n=a("7164"),s=a("e610"),c={name:"QuotaBomModal",components:{SelectParent:o["default"],MaterialList:n["default"],JImageUpload:s["default"]},computed:{materialSummary:function(){if(!this.selectedMaterialRows||0===this.selectedMaterialRows.length)return"";if(this.selectedMaterialRows.length<=3)return this.selectedMaterialRows.map((function(e){return e.code?"".concat(e.code,"-").concat(e.name):e.name})).join("；");var e=this.selectedMaterialRows.slice(0,3).map((function(e){return e.code?"".concat(e.code,"-").concat(e.name):e.name})).join("；");return"".concat(e," 等").concat(this.selectedMaterialRows.length,"项")}},data:function(){return{title:"",visible:!1,confirmLoading:!1,model:{},partRows:[],selectedMaterialRows:[],lineValues:[],positionValues:[],selectedStructId:"",structOptions:[],lineOptions:["1号线","1号线增购","2号线","2号线增购","2号线延线","3号线","4号线","4号线增购","5号线","6号线","7号线","11号线"],positionOptions:["TC1","MP1","M1","M2","MP2","TC2","ALL"],validatorRules:{trainType:[{required:!0,message:"请输入车型",trigger:"blur"}],bomCode:[{required:!0,message:"请输入编码",trigger:"blur"}],bomName:[{required:!0,message:"请输入BOM名称",trigger:"blur"}]}}},methods:{add:function(){this.title="新增定额BOM",this.visible=!0,this.model={trainType:"电客车"},this.partRows=[this.createEmptyPartRow()],this.selectedMaterialRows=[],this.lineValues=[],this.positionValues=[],this.selectedStructId="",this.loadStructOptions()},edit:function(e){this.title="编辑定额BOM",this.visible=!0,this.model=Object.assign({},e),this.lineValues=this.splitCsv(e.line),this.positionValues=this.splitCsv(e.position),this.partRows=this.parsePartRows(e.partDetails),this.selectedMaterialRows=this.parseMaterialLinks(e.materialLinks),this.selectedStructId="",this.loadStructOptions()},handleOk:function(){var e=this;this.$refs.form.validate((function(t){if(t){e.normalizePartRows(),e.model.line=e.joinCsv(e.lineValues),e.model.position=e.joinCsv(e.positionValues),e.model.trainType||(e.model.trainType="电客车"),e.model.materialLinks=JSON.stringify(e.selectedMaterialRows||[]),e.model.partDetails=JSON.stringify(e.partRows),e.confirmLoading=!0;var a=e.model.id?Object(l["Vd"])(e.model):Object(l["ud"])(e.model);a.then((function(t){t.success?(e.$message.success(e.model.id?"修改成功":"新增成功"),e.visible=!1,e.$emit("ok")):e.$message.error(t.message||"操作失败")})).finally((function(){e.confirmLoading=!1}))}}))},handleCancel:function(){this.visible=!1,this.$refs.form.resetFields(),this.partRows=[],this.selectedMaterialRows=[]},loadStructOptions:function(){var e=this;Object(l["qc"])().then((function(t){t&&t.success?e.structOptions=t.result||[]:e.structOptions=[]})).catch((function(){e.structOptions=[]}))},onStructChange:function(){},openMaterialSelect:function(){this.$refs.materialSelect.showModal()},onMaterialSelected:function(e){var t=(e||[]).map((function(e){return{id:e.id,code:e.code,name:e.name,category1:e.category1,category1_dictText:e.category1_dictText}})).filter((function(e){return e.id})),a={};this.selectedMaterialRows=t.filter((function(e){return!a[e.id]&&(a[e.id]=!0,!0)})),this.model.materialLinks=JSON.stringify(this.selectedMaterialRows)},clearSelectedMaterials:function(){this.selectedMaterialRows=[],this.model.materialLinks="[]"},openStructDetailSelect:function(){this.selectedStructId?this.$refs.structDetailSelect.showModal():this.$message.warning("请先选择车辆结构")},onStructDetailSelected:function(e){if(e&&0!==e.length){var t=e[0];this.model.bomCode=this.model.bomCode||t.code||"",this.model.bomName=this.model.bomName||t.name||"",this.model.system=this.model.system||t.parentName||"",this.model.moduleLevel2=this.model.moduleLevel2||t.name||"",this.model.moduleLevel3=this.model.moduleLevel3||"",t.placeCode&&(this.positionValues=this.mergeUnique(this.positionValues,[t.placeCode]));var a=this.createEmptyPartRow();a.partNo=t.code||"",a.name=t.name||"",a.spec=t.shortName||"",this.partRows.push(a),this.$message.success("已按结构明细填充，可继续手动编辑")}},addPartRow:function(){this.partRows.push(this.createEmptyPartRow())},removePartRow:function(e){this.partRows.splice(e,1),0===this.partRows.length&&this.partRows.push(this.createEmptyPartRow())},normalizePartRows:function(){this.partRows=(this.partRows||[]).filter((function(e){return Object.keys(e).some((function(t){return 0===t.indexOf("req")?!!e[t]:""!==String(e[t]||"").trim()}))})),0===this.partRows.length&&this.partRows.push(this.createEmptyPartRow())},createEmptyPartRow:function(){return{partNo:"",name:"",spec:"",drawingQty:0,trainQty:0,materialCode:"",reqFirstFrame:!1,reqFirstMajor:!1,reqSecondFrame:!1,reqSecondMajor:!1,reqThirdFrame:!1}},parsePartRows:function(e){var t=this;if(!e)return[this.createEmptyPartRow()];try{var a=JSON.parse(e);return Array.isArray(a)&&0!==a.length?a.map((function(e){return{partNo:e.partNo||"",name:e.name||"",spec:e.spec||"",drawingQty:t.toNumber(e.drawingQty),trainQty:t.toNumber(e.trainQty),materialCode:e.materialCode||"",reqFirstFrame:!!e.reqFirstFrame,reqFirstMajor:!!e.reqFirstMajor,reqSecondFrame:!!e.reqSecondFrame,reqSecondMajor:!!e.reqSecondMajor,reqThirdFrame:!!e.reqThirdFrame}})):[this.createEmptyPartRow()]}catch(i){return[this.createEmptyPartRow()]}},parseMaterialLinks:function(e){if(!e)return[];try{var t=JSON.parse(e);return Array.isArray(t)?t.map((function(e){return{id:e.id||e.materialTypeId||e.materialCode||e.code,code:e.code||e.materialCode||"",name:e.name||e.materialName||"",category1:e.category1,category1_dictText:e.category1_dictText}})).filter((function(e){return e.id})):[]}catch(a){return[]}},splitCsv:function(e){return e?String(e).split(",").map((function(e){return e.trim()})).filter(Boolean):[]},joinCsv:function(e){return(e||[]).map((function(e){return String(e).trim()})).filter(Boolean).join(",")},mergeUnique:function(e,t){var a={};return(e||[]).forEach((function(e){a[e]=!0})),(t||[]).forEach((function(e){e&&(a[e]=!0)})),Object.keys(a)},toNumber:function(e){var t=Number(e);return Number.isNaN(t)||t<0?0:t}}},d=c,u=a("2877"),m=Object(u["a"])(d,i,r,!1,null,null,null);t["default"]=m.exports},a743:function(e,t,a){"use strict";a("db1d")},ba3d:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"table-page-search-wrapper"},[t("a-form",{attrs:{layout:"inline"},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}}},[t("a-row",{attrs:{gutter:24}},[t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"BOM编码"}},[t("a-input",{attrs:{placeholder:"请输入BOM编码",allowClear:""},model:{value:e.queryParam.bomCode,callback:function(t){e.$set(e.queryParam,"bomCode",t)},expression:"queryParam.bomCode"}})],1)],1),t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"车型"}},[t("a-select",{attrs:{placeholder:"请选择车型",allowClear:""},model:{value:e.queryParam.trainType,callback:function(t){e.$set(e.queryParam,"trainType",t)},expression:"queryParam.trainType"}},[t("a-select-option",{attrs:{value:""}},[e._v("全部")]),t("a-select-option",{attrs:{value:"电客车"}},[e._v("电客车")]),t("a-select-option",{attrs:{value:"电动车组"}},[e._v("电动车组")])],1)],1)],1),e.advanced?[t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"BOM名称"}},[t("a-input",{attrs:{placeholder:"请输入BOM名称",allowClear:""},model:{value:e.queryParam.bomName,callback:function(t){e.$set(e.queryParam,"bomName",t)},expression:"queryParam.bomName"}})],1)],1),t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"线别"}},[t("a-select",{attrs:{mode:"multiple",placeholder:"请选择线别(可多选)",allowClear:""},model:{value:e.lineFilterValues,callback:function(t){e.lineFilterValues=t},expression:"lineFilterValues"}},e._l(e.lineOptions,(function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v(e._s(a))])})),1)],1)],1),t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"位置"}},[t("a-select",{attrs:{mode:"multiple",placeholder:"请选择位置(可多选)",allowClear:""},model:{value:e.positionFilterValues,callback:function(t){e.positionFilterValues=t},expression:"positionFilterValues"}},e._l(e.positionOptions,(function(a){return t("a-select-option",{key:a,attrs:{value:a}},[e._v(e._s(a))])})),1)],1)],1),t("a-col",{attrs:{md:6,sm:24}},[t("a-form-item",{attrs:{label:"系统"}},[t("a-input",{attrs:{placeholder:"请输入系统",allowClear:""},model:{value:e.queryParam.system,callback:function(t){e.$set(e.queryParam,"system",t)},expression:"queryParam.system"}})],1)],1)]:e._e(),t("a-col",{attrs:{md:6,sm:8}},[t("span",{staticClass:"table-page-search-submitButtons",staticStyle:{float:"left",overflow:"hidden"}},[t("a-space",[t("a-button",{attrs:{type:"primary"},on:{click:e.handleAdd}},[e._v("新增")]),t("a-button",{attrs:{disabled:1!=e.selectRows.length},on:{click:function(t){return e.handleEdit(e.selectRows[0])}}},[e._v("编辑")]),t("a-button",{attrs:{disabled:1!=e.selectRows.length},on:{click:function(t){return e.showDetail(e.selectRows[0])}}},[e._v("查看")]),t("a-button",{attrs:{disabled:e.selectRows.length<1},on:{click:e.handleDelete}},[e._v("删除")]),t("a-button",{on:{click:e.handleExport}},[e._v("导出")]),t("a-upload",{attrs:{name:"file",showUploadList:!1,multiple:!1,headers:e.tokenHeader,action:e.importExcelUrl},on:{change:e.handleImportExcel}},[t("a-button",[e._v("导入")])],1),t("a-button",{on:{click:e.handleSearch}},[e._v("查询")]),t("a",{on:{click:function(t){e.advanced=!e.advanced}}},[e._v(" "+e._s(e.advanced?"收起":"展开")+" "),t("a-icon",{attrs:{type:e.advanced?"up":"down"}})],1)],1)],1)])],2)],1)],1),t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:7}},[t("a-card",{staticStyle:{height:"calc(100vh - 225px)",overflow:"auto"},attrs:{title:"BOM结构树",bordered:!1}},[t("a-tree",{attrs:{treeData:e.treeData,defaultExpandAll:!0,replaceFields:{children:"children",title:"title",key:"key"}},on:{select:e.onTreeSelect}})],1)],1),t("a-col",{attrs:{span:17}},[t("div",{staticStyle:{height:"calc(100vh - 225px)"}},[t("vxe-table",{ref:"listTable",staticStyle:{height:"calc(100vh - 225px)"},attrs:{border:"","auto-resize":"","max-height":"100%",align:e.allAlign,data:e.tableData,"show-overflow":"tooltip","checkbox-config":{trigger:"row",highlight:!0,range:!0}},on:{"checkbox-change":e.checkboxChange,"checkbox-all":e.checkboxChange}},[t("vxe-table-column",{attrs:{type:"checkbox",width:"40"}}),t("vxe-table-column",{attrs:{field:"bomCode",title:"BOM编码",width:"15%","header-align":"center",align:"left"}}),t("vxe-table-column",{attrs:{field:"bomName",title:"BOM名称",width:"20%","header-align":"center",align:"left"}}),t("vxe-table-column",{attrs:{field:"trainType",title:"车型",width:"15%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"line",title:"线别",width:"10%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"position",title:"位置",width:"10%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"system",title:"系统",width:"12%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"moduleLevel2",title:"二级模块",width:"12%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"moduleLevel3",title:"三级模块",width:"12%","header-align":"center",align:"center"}}),t("vxe-table-column",{attrs:{field:"createTime",title:"创建日期",width:"18%",formatter:e.formatDate}}),t("vxe-table-column",{attrs:{field:"remark",title:"备注",width:"15%","header-align":"center",align:"left"}})],1),t("vxe-pager",{attrs:{perfect:"","current-page":e.queryParam.pageNo,"page-size":e.queryParam.pageSize,total:e.totalResult,layouts:["PrevJump","PrevPage","Number","NextPage","NextJump","Sizes","FullJump","Total"]},on:{"update:currentPage":function(t){return e.$set(e.queryParam,"pageNo",t)},"update:current-page":function(t){return e.$set(e.queryParam,"pageNo",t)},"update:pageSize":function(t){return e.$set(e.queryParam,"pageSize",t)},"update:page-size":function(t){return e.$set(e.queryParam,"pageSize",t)},"page-change":e.handlePageChange}})],1)])],1),t("quota-bom-modal",{ref:"quotaModal",on:{ok:e.handleModalOk}}),t("a-drawer",{attrs:{title:"BOM查看",placement:"right",width:980,visible:e.detailVisible,destroyOnClose:!1},on:{close:function(t){e.detailVisible=!1}}},[t("a-row",{attrs:{gutter:12}},[t("a-col",{attrs:{span:10}},[t("a-card",{staticStyle:{height:"calc(100vh - 180px)",overflow:"auto"},attrs:{title:"结构树",bordered:!1}},[t("a-tree",{attrs:{treeData:e.detailTreeData,defaultExpandAll:!0,replaceFields:{children:"children",title:"title",key:"key"}}})],1)],1),t("a-col",{attrs:{span:14}},[t("a-card",{staticStyle:{"margin-bottom":"12px"},attrs:{title:"爆炸图",bordered:!1}},[e.detailRecord.explosionDiagram?t("img",{staticStyle:{width:"100%","max-height":"260px","object-fit":"contain",border:"1px solid #f0f0f0"},attrs:{src:e.detailRecord.explosionDiagram}}):t("a-empty",{attrs:{description:"暂无爆炸图"}})],1),t("a-card",{staticStyle:{height:"calc(100vh - 460px)",overflow:"auto"},attrs:{title:"部件明细",bordered:!1}},[t("vxe-table",{attrs:{border:"",size:"mini",data:e.detailPartRows,"max-height":"320"}},[t("vxe-table-column",{attrs:{type:"seq",width:"50",title:"#"}}),t("vxe-table-column",{attrs:{field:"partNo",title:"件号","min-width":"110"}}),t("vxe-table-column",{attrs:{field:"name",title:"名称","min-width":"120"}}),t("vxe-table-column",{attrs:{field:"spec",title:"规格型号","min-width":"120"}}),t("vxe-table-column",{attrs:{field:"drawingQty",title:"图上数量",width:"90"}}),t("vxe-table-column",{attrs:{field:"trainQty",title:"1列车数量",width:"95"}}),t("vxe-table-column",{attrs:{field:"materialCode",title:"物资编码","min-width":"100"}}),t("vxe-table-column",{attrs:{field:"maintReqText",title:"维修要求","min-width":"180"}})],1),t("a-divider",{staticStyle:{margin:"12px 0"}}),t("div",{staticStyle:{"font-weight":"500","margin-bottom":"8px"}},[e._v("关联物资")]),t("vxe-table",{attrs:{border:"",size:"mini",data:e.detailMaterials,"max-height":"180"}},[t("vxe-table-column",{attrs:{type:"seq",width:"50",title:"#"}}),t("vxe-table-column",{attrs:{field:"code",title:"物资编码","min-width":"120"}}),t("vxe-table-column",{attrs:{field:"name",title:"物资名称","min-width":"160"}}),t("vxe-table-column",{attrs:{field:"category",title:"分类","min-width":"100"}})],1)],1)],1)],1)],1)],1)},r=[],l=a("c1df"),o=a.n(l),n=(a("5c3a"),a("6b57")),s=a("8fad"),c=a("0fea"),d=a("2b0e"),u=a("9fb0");function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function p(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function h(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?p(Object(a),!0).forEach((function(t){f(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):p(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function f(e,t,a){return(t=b(t))in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function b(e){var t=v(e,"string");return"symbol"==m(t)?t:t+""}function v(e,t){if("object"!=m(e)||!e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var i=a.call(e,t||"default");if("object"!=m(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var g={name:"QuotaBom",components:{QuotaBomModal:n["default"]},computed:{importExcelUrl:function(){return"".concat(window._CONFIG["domianURL"],"/base/quota-bom/importExcel")}},data:function(){return{selectRows:[],advanced:!1,tokenHeader:{"X-Access-Token":d["default"].ls.get(u["a"])},queryParam:{bomCode:"",bomName:"",trainType:"",line:"",position:"",system:"",pageNo:1,pageSize:10},totalResult:0,allAlign:"center",tableData:[],loading:!1,treeData:[],lineFilterValues:[],positionFilterValues:[],lineOptions:["1号线","1号线增购","2号线","2号线增购","2号线延线","3号线","4号线","4号线增购","5号线","6号线","7号线","11号线"],positionOptions:["TC1","MP1","M1","M2","MP2","TC2","ALL"],detailVisible:!1,detailRecord:{},detailPartRows:[],detailMaterials:[],detailTreeData:[]}},created:function(){this.loadData(),this.loadTree()},methods:{checkboxChange:function(e){this.selectRows=e.records},loadData:function(){var e=this;this.loading=!0,Object(s["Wc"])(this.queryParam).then((function(t){t.success&&(e.tableData=t.result.records||[],e.totalResult=t.result.total||0)})).finally((function(){e.loading=!1}))},loadTree:function(){var e=this;Object(s["Pc"])({trainType:this.queryParam.trainType}).then((function(t){t&&t.success&&(e.treeData=t.result||[])}))},onTreeSelect:function(e,t){var a=t&&t.node&&t.node.dataRef;if(a&&6===a.level&&a.bomId){var i=(this.tableData||[]).find((function(e){return e.id===a.bomId}));this.selectRows=i?[i]:[],i&&(this.$message.info("已定位到BOM：".concat(i.bomCode)),this.showDetail(i))}},handleSearch:function(){this.queryParam.line=this.joinCsv(this.lineFilterValues),this.queryParam.position=this.joinCsv(this.positionFilterValues),this.queryParam.pageNo=1,this.loadData(),this.loadTree()},handlePageChange:function(e){var t=e.currentPage,a=e.pageSize;this.queryParam.pageNo=t,this.queryParam.pageSize=a,this.loadData()},handleAdd:function(){this.$refs.quotaModal.add()},handleEdit:function(e){this.$refs.quotaModal.edit(e)},handleModalOk:function(){this.loadData(),this.loadTree()},handleDelete:function(){var e=this;0!==this.selectRows.length?this.$confirm({title:"删除确认",content:"确认删除选中的定额BOM吗？",onOk:function(){var t=e.selectRows.map((function(e){return e.id})).join(",");Object(s["db"])({ids:t}).then((function(t){t.success&&(e.$message.success("删除成功"),e.selectRows=[],e.loadData(),e.loadTree())}))}}):this.$message.warning("请先选择要删除的记录")},handleExport:function(){var e=this,t=h({},this.queryParam);Object(c["b"])("/base/quota-bom/exportXls",t).then((function(t){if(t){var a=new Blob([t],{type:"application/vnd.ms-excel"}),i=window.URL.createObjectURL(a),r=document.createElement("a");r.style.display="none",r.href=i,r.setAttribute("download","定额BOM.xls"),document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(i)}else e.$message.warning("文件下载失败")}))},handleImportExcel:function(e){"done"===e.file.status?e.file.response&&e.file.response.success?(this.$message.success(e.file.response.message||"".concat(e.file.name," 导入成功")),this.loadData()):this.$message.error(e.file.response?e.file.response.message:"导入失败"):"error"===e.file.status&&this.$message.error("文件上传失败")},formatDate:function(e){return e.createTime?o()(e.createTime).format("YYYY-MM-DD HH:mm:ss"):""},showDetail:function(e){this.detailRecord=e||{},this.detailPartRows=this.parsePartRows(e?e.partDetails:""),this.detailMaterials=this.parseMaterials(e?e.materialLinks:""),this.detailTreeData=this.buildDetailTree(e),this.detailVisible=!0},buildDetailTree:function(e){if(!e)return[];var t=e.trainType||"未定义车型",a=e.line||"未定义线别",i=e.position||"未定义位置",r=e.system||"未定义系统",l=e.moduleLevel2||"未定义二级模块",o=e.moduleLevel3||"未定义三级模块",n="".concat(e.bomCode||"-"," - ").concat(e.bomName||"未命名BOM");return[{key:"root",title:t,children:[{key:"line",title:a,children:[{key:"position",title:i,children:[{key:"system",title:r,children:[{key:"module2",title:l,children:[{key:"module3",title:o,children:[{key:"bom",title:n}]}]}]}]}]}]}]},parsePartRows:function(e){var t=this;if(!e)return[];try{var a=JSON.parse(e);return Array.isArray(a)?a.map((function(e){return h(h({},e),{},{maintReqText:t.renderMaintReq(e)})})):[]}catch(i){return[]}},parseMaterials:function(e){if(!e)return[];try{var t=JSON.parse(e);return Array.isArray(t)?t.map((function(e){return{id:e.id||e.materialTypeId||e.materialCode||e.code,code:e.code||e.materialCode||"",name:e.name||e.materialName||"",category:e.category1_dictText||e.category1||""}})):[]}catch(a){return[]}},renderMaintReq:function(e){var t=[];return e.reqFirstFrame&&t.push("一架"),e.reqFirstMajor&&t.push("一大"),e.reqSecondFrame&&t.push("二架"),e.reqSecondMajor&&t.push("二大"),e.reqThirdFrame&&t.push("三架"),t.join("、")},joinCsv:function(e){return(e||[]).map((function(e){return String(e).trim()})).filter(Boolean).join(",")}}},y=g,w=(a("c1aa"),a("2877")),x=Object(w["a"])(y,i,r,!1,null,"73843b56",null);t["default"]=x.exports},c1aa:function(e,t,a){"use strict";a("ea60")},db1d:function(e,t,a){},e610:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e._self._c;return t("a-upload",{attrs:{name:"file",listType:"picture-card",multiple:e.isMultiple,action:e.uploadAction,headers:e.headers,data:{fileName:e.bizPath},fileList:e.fileList,beforeUpload:e.beforeUpload,disabled:e.disabled,isMultiple:e.isMultiple,showUploadList:e.isMultiple},on:{change:e.handleChange,preview:e.handlePreview}},[!e.isMultiple&&e.picUrl?t("img",{staticStyle:{height:"104px","max-width":"300px"},attrs:{src:e.getAvatarView()}}):t("div",[t("a-icon",{attrs:{type:e.uploadLoading?"loading":"plus"}}),t("div",{staticClass:"ant-upload-text"},[e._v(e._s(e.text))])],1),t("a-modal",{attrs:{visible:e.previewVisible,footer:null},on:{cancel:function(t){return e.handleCancel()}}},[t("img",{staticStyle:{width:"100%"},attrs:{alt:"example",src:e.previewImage}})])],1)},r=[],l=a("2b0e"),o=a("9fb0"),n=a("0fea"),s=function(){return"-"+parseInt(1e4*Math.random()+1,10)},c=function(e){if(e.lastIndexOf("\\")>=0){var t=new RegExp("\\\\","g");e=e.replace(t,"/")}return e.substring(e.lastIndexOf("/")+1)},d={name:"JImageUpload",data:function(){return{uploadAction:window._CONFIG["fileServiceUrl"]+"/oss/file/upload",uploadLoading:!1,picUrl:!1,headers:{},fileList:[],previewImage:"",previewVisible:!1}},props:{text:{type:String,required:!1,default:"上传"},bizPath:{type:String,required:!1,default:"/img"},value:{type:[String,Array],required:!1},disabled:{type:Boolean,required:!1,default:!1},isMultiple:{type:Boolean,required:!1,default:!1}},watch:{value:function(e){e instanceof Array?this.initFileList(e.join(",")):this.initFileList(e)}},created:function(){var e=l["default"].ls.get(o["a"]);this.headers={"X-Access-Token":e}},methods:{initFileList:function(e){if(e&&0!=e.length){this.picUrl=!0;for(var t=[],a=e.split(","),i=function(e){var i;Object(n["f"])(a[e]).then((function(r){i=r,t.push({uid:s(),name:c(a[e]),status:"done",url:i,response:{status:"history",message:a[e]}})}))},r=0;r<a.length;r++)i(r);this.fileList=t}else this.fileList=[]},beforeUpload:function(e){var t=e.type;if(t.indexOf("image")<0)return this.$message.warning("请上传图片"),!1},handleChange:function(e){this.picUrl=!1;var t=e.fileList;"done"===e.file.status?e.file.response.success&&(this.picUrl=!0,t=t.map((function(e){return e.response&&(e.url=e.response.result),e}))):"error"===e.file.status?this.$message.error("".concat(e.file.name," 上传失败.")):"removed"===e.file.status&&this.handleDelete(e.file),this.fileList=t,"done"!==e.file.status&&"removed"!==e.file.status||this.handlePathChange()},handlePreview:function(e){this.previewImage=e.url||e.thumbUrl,this.previewVisible=!0},getAvatarView:function(){if(this.fileList.length>0){var e=this.fileList[0].url;return e}},handlePathChange:function(){var e=this.fileList,t="";e&&0!=e.length||(t="");var a=[];if(this.isMultiple)for(var i=0;i<e.length;i++)a.push(e[i].response.result);else a.push(e[e.length-1].response.result);a.length>0&&(t=a.join(",")),this.$emit("change",t)},handleDelete:function(e){},handleCancel:function(){this.close(),this.previewVisible=!1},close:function(){}},model:{prop:"value",event:"change"}},u=d,m=a("2877"),p=Object(m["a"])(u,i,r,!1,null,"1ef1dc4c",null);t["default"]=p.exports},ea60:function(e,t,a){}}]);